@model ChhayaNirh.Models.Post
@{
    ViewBag.Title = "Post Details";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="~/Content/post.css" rel="stylesheet" />
<link href="~/Content/CommentModal.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<div class="comment-page-container" style="background-color: #FFFFF0;">
    <!-- Page Header with Delete Button -->
    <div class="comment-page-header" style="display: flex; align-items: center; justify-content: space-between; background-color: #FFFFF0;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <button class="back-btn" onclick="goBack()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h3 class="page-title" style="margin: 0;">@Model.User.FullName's post</h3>
        </div>
        <button class="delete-btn" onclick="deletePost(@Model.Id)">
            <i class="fas fa-trash-alt"></i> Delete Post
        </button>
    </div>

    <!-- Post Content -->
    <div class="post-content-page">
        <div class="post-card" style="background-color: #FFFFF0;">
            <div class="post-header">
                <img src="@(string.IsNullOrEmpty(Model.User?.ProfilePicturePath) ? Url.Content("~/Content/Images/default-profile2.png") : Url.Content(Model.User.ProfilePicturePath))"
                     alt="Profile" class="profile-pic" style="width: 50px; height: 50px;" />
                <div class="post-user-info">
                    <h6>@Model.User.FullName</h6>
                    <p class="post-time">@Model.CreatedAt.ToString("MMM dd, yyyy 'at' HH:mm")</p>
                </div>
                <span class="badge @(Model.PostType == "Owner" ? "owner-badge" : "renter-badge") badge-post-type">
                    @Model.PostType
                </span>
            </div>

            <div class="post-content">
                <div class="post-details">
                    <h6 class="mb-2">@Model.HouseType in @Model.Area</h6>

                    <!-- See Location link -->
                    @if (Model.Latitude != 0 && Model.Longitude != 0)
                    {
                        <p>
                            <a class="text-primary" data-bs-toggle="collapse" href="#postMapContainer" role="button" aria-expanded="false" aria-controls="postMapContainer">
                                <i class="fas fa-map-marker-alt"></i> See Location
                            </a>
                        </p>
                    }

                    @if (Model.PostType == "Owner")
                    {
                        <div class="row">
                            <div class="col-6"><small><strong>Bedrooms:</strong> @Model.Bedrooms</small></div>
                            <div class="col-6"><small><strong>Bathrooms:</strong> @Model.Bathrooms</small></div>
                            <div class="col-12 mt-1"><small><strong>Rent:</strong> <span class="text-success fw-bold">৳@Model.RentAmount</span></small></div>
                        </div>
                    }
                    else if (Model.PostType == "Renter")
                    {
                        <div class="row">
                            <div class="col-12"><small><strong>Budget:</strong> <span class="text-primary fw-bold">৳@Model.Budget</span></small></div>
                            <div class="col-12 mt-1"><small><strong>Preferred Type:</strong> @Model.HouseType</small></div>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(Model.Amenities))
                    {
                        <div class="mt-2"><small><strong>Amenities:</strong> @Model.Amenities</small></div>
                    }
                </div>

                @if (!string.IsNullOrEmpty(Model.Description))
                {
                    <p class="mb-2">@Model.Description</p>
                }

                @if (!string.IsNullOrEmpty(Model.MediaPaths))
                {
                    <div class="post-images">
                        @foreach (var imagePath in Model.MediaPaths.Split(','))
                        {
                            <img src="@Url.Content(imagePath.Trim())" alt="Post Image" />
                        }
                    </div>
                }
            </div>

            <!-- Map Container -->
            <div id="postMapContainer" class="collapse mb-3">
                <div id="postMap" style="height: 400px; width: 100%;"></div>
            </div>

            <!-- Post Actions -->
            <div class="post-actions" style="padding: 15px; border-top: 1px solid #e4e6ea; display: flex; justify-content: space-around;">
                <button class="action-btn like-btn @(ViewBag.IsLiked ? "liked" : "")" data-post-id="@Model.Id">
                    <i class="fas fa-heart"></i> <span class="like-count">@Model.LikeCount</span> Likes
                </button>
                <button class="action-btn comment-btn" data-post-id="@Model.Id"><i class="fas fa-comment"></i> Comment</button>
                <button class="action-btn contact-btn" onclick="contactUser()"><i class="fas fa-envelope"></i> Contact</button>
            </div>
        </div>
    </div>

    <!-- Comments Section -->
    <div class="comments-section-page" id="comments-list">
        <div class="loading-comments">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading comments...</p>
        </div>
    </div>

    <!-- Comment Input -->
    <div class="comment-input-section" style="background-color: #FFFFF0;">
        <div class="comment-input-area">
            <img src="@ViewBag.ProfilePicturePath" alt="Your Profile" class="profile-pic" style="width: 32px; height: 32px;" />
            <textarea class="comment-input" id="commentText" placeholder="Write a comment..." rows="1"></textarea>
            <button class="send-btn" id="sendComment" disabled>
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this post?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    Post deleted successfully!
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    $(document).ready(function () {
        // Comments
        loadComments();

        $('#commentText').on('input', function () {
            $('#sendComment').prop('disabled', $(this).val().trim() === '');
        });

        $('#sendComment').click(function () {
            var commentText = $('#commentText').val();
            if (commentText.trim() === '') return;

            $.post('@Url.Action("AddComment", "Post")', { postId: @Model.Id, commentText: commentText }, function (res) {
                if (res.success) {
                    $('#commentText').val('');
                    loadComments();
                } else {
                    alert(res.error);
                }
            });
        });

        function loadComments() {
            $.get('@Url.Action("GetComments", "Post")', { postId: @Model.Id }, function (result) {
                $('#comments-list').html(result);
            }).fail(function () {
                $('#comments-list').html('<p class="text-danger">Unable to load comments.</p>');
            });
        }

        // Leaflet Map
        var mapInitialized = false;
        var postLat = @Model.Latitude;
        var postLng = @Model.Longitude;

        document.getElementById('postMapContainer').addEventListener('shown.bs.collapse', function () {
            if (!mapInitialized && postLat && postLng) {
                var postMap = L.map('postMap').setView([postLat, postLng], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(postMap);

                L.marker([postLat, postLng]).addTo(postMap)
                    .bindPopup("@Model.Area")
                    .openPopup();

                setTimeout(() => postMap.invalidateSize(), 300);
                mapInitialized = true;
            }
        });
    });

    function goBack() {
        if (document.referrer && document.referrer.indexOf(window.location.host) !== -1) {
            window.history.back();
        } else {
            window.location.href = '@Url.Action("Post", "Post")';
        }
    }

    function contactUser() {
        window.location.href = 'https://localhost:44366/Chat';
    }

    function deletePost(postId) {
    // Show confirmation modal
    var deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    deleteModal.show();

    // When user clicks confirm
    $('#confirmDeleteBtn').off('click').on('click', function () {
        $.ajax({
            url: '@Url.Action("DeletePost", "Post")',
            type: 'POST',
            data: { id: postId },
            success: function (res) {
                deleteModal.hide(); // hide confirmation modal
                if (res.success) {
                    // Show success modal
                    var successModal = new bootstrap.Modal(document.getElementById('successModal'));
                    successModal.show();
                    setTimeout(function () {
                        window.location.href = '@Url.Action("Post", "Post")';
                    }, 1500); // redirect after 1.5 seconds
                } else {
                    alert(res.error); // fallback if error
                }
            },
            error: function () {
                deleteModal.hide();
                alert('Error deleting post.');
            }
        });
    });
}
</script>

<style>
    .contact-btn {
        background: none;
        border: none;
        color: #65676b;
        padding: 8px 15px;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        flex: 1;
        justify-content: center;
        transition: all 0.3s ease;
        font-size: 14px;
        font-weight: 500;
    }

    .like-btn.liked {
        color: red;
    }

    .comment-input {
        width: 100%;
        resize: none;
        border-radius: 8px;
        padding: 6px 10px;
        border: 1px solid #ccc;
    }

    .send-btn {
        background-color: #0d6efd;
        color: white;
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }

        .send-btn:disabled {
            background-color: #b0c4de;
            cursor: not-allowed;
        }

    /* Small Delete Button */
    /* Small Delete Button with text */
    .delete-btn {
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 3px 8px; /* slightly wider to fit text */
        cursor: pointer;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 4px; /* space between icon and text */
        transition: all 0.3s ease;
    }

        .delete-btn:hover {
            background-color: #c82333;
        }

</style>
